@using MyEshop_Phone.Application.DTO
@model RegisterUserDTO
@{
    ViewData["Title"] = "ثبت نام کاربران";
    Layout = null;
}

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#F8FAFC" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; img-src 'self' data: https:; script-src 'self' https://cdn.tailwindcss.com 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self'">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>@ViewData["Title"]</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="/Layout/assets/css/style.css" />
</head>
<body class="bg-[#F8FAFC] text-gray-900 overflow-x-hidden font-[Vazirmatn] no-navbar" data-auth="guest">
    <div id="top" aria-hidden="true"></div>



    <main id="main-content" class="min-h-screen flex items-center py-10">
        <div class="max-w-7xl mx-auto px-4">
            <div class="w-full max-w-md mx-auto bg-gradient-to-b from-white via-white to-slate-50 rounded-3xl border border-slate-100 shadow-2xl shadow-[#2563EB]/10 overflow-hidden sm:min-h-[560px]">
                <div class="p-8 sm:p-10">
                    <div class="flex items-center mb-6">
                        <a href="/" class="flex items-center gap-2 text-gray-600 hover:text-[#2563EB] transition-colors" aria-label="بازگشت به فروشگاه">
                            <span class="material-icon" aria-hidden="true">arrow_forward</span>
                            <span class="font-bold">بازگشت</span>
                        </a>
                    </div>

                    <div id="register-step" class="transition-opacity duration-300 ease-out">
                        <div class="text-center mb-8">
                            <a href="/" class="inline-flex items-center gap-2 mb-4" aria-label="بازگشت به صفحه اصلی">
                                <span class="material-icon text-3xl text-[#2563EB]" aria-hidden="true">shopping_bag</span>
                                <span class="font-black text-xl text-gray-900">ماهان شاپ</span>
                            </a>
                            <h1 class="text-2xl font-bold text-gray-900">ایجاد حساب کاربری</h1>
                            <p class="text-sm text-gray-500 mt-2">اطلاعات خود را برای عضویت وارد کنید</p>
                        </div>

                        <form method="post" id="register-form" class="space-y-6" novalidate>
                            <p style="color:red">@ViewBag.User</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="firstname" class="block text-sm font-medium text-gray-700 mb-2">نام:</label>
                                    <div class="relative">
                                        <span class="material-icon absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" aria-hidden="true">person</span>
                                        <input asp-for="Name" placeholder="نام" autocomplete="given-name" autocapitalize="off" maxlength="24" spellcheck="false" aria-describedby="register-error" class="auth-input w-full pl-4 pr-10 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#2563EB]" required>
                                    </div>
                                </div>
                                <div>
                                    <label for="lastname" class="block text-sm font-medium text-gray-700 mb-2">نام خانوادگی:</label>
                                    <div class="relative">
                                        <span class="material-icon absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" aria-hidden="true">person</span>
                                        <input asp-for="Family" placeholder="نام خانوادگی" autocomplete="family-name" autocapitalize="off" maxlength="32" spellcheck="false" aria-describedby="register-error" class="auth-input w-full pl-4 pr-10 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#2563EB]" required>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label for="phone-register" class="block text-sm font-medium text-gray-700 mb-2">شماره موبایل:</label>
                                <div class="relative">
                                    <span class="material-icon absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" aria-hidden="true">smartphone</span>
                                    <input asp-for="Number" placeholder="09123456789" dir="ltr" inputmode="numeric" autocomplete="tel" autocapitalize="off" maxlength="11" aria-describedby="register-help register-error" class="auth-input w-full pl-4 pr-10 py-3 rounded-xl border border-gray-300 text-left focus:outline-none focus:ring-2 focus:ring-[#2563EB]" required pattern="09[0-9]{9}">
                                </div>
                                <p id="register-help" class="mt-2 text-xs text-gray-500">شماره باید با 09 شروع شود و 11 رقم باشد.</p>
                                <p id="register-error" class="mt-2 text-xs text-red-600 hidden" role="alert"></p>
                            </div>
                            <p style="color:red">@ViewBag.Error</p>
                            <button type="submit" id="send-otp-btn" class="w-full bg-[#2563EB] text-white font-bold py-3.5 rounded-xl hover:bg-[#1D4ED8] transition-colors shadow-lg shadow-[#2563EB]/20 flex items-center justify-center gap-2 ripple">
                                دریافت کد تایید
                                <span class="material-icon text-sm" aria-hidden="true">send</span>
                            </button>
                        </form>

                        <div class="mt-6 text-center">
                            <p class="text-sm text-gray-600">
                                قبلاً ثبت نام کرده‌اید؟
                                <a href="/Login" class="text-[#2563EB] font-bold hover:underline">وارد شوید</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>




    <script defer src="/Layout/assets/js/layout.js"></script>
    <script defer src="/Layout/assets/js/script.js"></script>
    <div data-include="footer"></div>

    @section Scripts{
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                  const registerForm = document.getElementById('register-form');
                  const registerStep = document.getElementById('register-step');
                  const otpStep = document.getElementById('otp-step');
                  const otpForm = document.getElementById('otp-form');
                  const firstNameInput = document.getElementById('firstname');
                  const lastNameInput = document.getElementById('lastname');
                  const phoneInput = document.getElementById('phone-register');
                  const sendOtpBtn = document.getElementById('send-otp-btn');
                  const registerError = document.getElementById('register-error');
                  const otpError = document.getElementById('otp-error');
                  const otpPhoneDisplay = document.getElementById('otp-phone-display');
                  const resendBtn = document.getElementById('resend-btn');
                  const countdown = document.getElementById('countdown');
                  const editPhoneBtn = document.getElementById('edit-phone-btn');
                  const otpInputs = document.querySelectorAll('#otp-form input[type="text"]');
                  let resendTimer = null;
                  let timeLeft = 60;

                  const setRegisterError = (message) => {
                    if (!registerError) return;
                    if (message) {
                      registerError.textContent = message;
                      registerError.classList.remove('hidden');
                      firstNameInput.setAttribute('aria-invalid', 'true');
                      lastNameInput.setAttribute('aria-invalid', 'true');
                      phoneInput.setAttribute('aria-invalid', 'true');
                    } else {
                      registerError.textContent = '';
                      registerError.classList.add('hidden');
                      firstNameInput.removeAttribute('aria-invalid');
                      lastNameInput.removeAttribute('aria-invalid');
                      phoneInput.removeAttribute('aria-invalid');
                    }
                  };

                  const setOtpError = (message) => {
                    if (!otpError) return;
                    if (message) {
                      otpError.textContent = message;
                      otpError.classList.remove('hidden');
                      otpInputs.forEach((input) => input.setAttribute('aria-invalid', 'true'));
                    } else {
                      otpError.textContent = '';
                      otpError.classList.add('hidden');
                      otpInputs.forEach((input) => input.removeAttribute('aria-invalid'));
                    }
                  };

                  const resetResendTimer = () => {
                    timeLeft = 60;
                    resendBtn.disabled = true;
                    resendBtn.classList.add('text-gray-400', 'cursor-not-allowed');
                    resendBtn.classList.remove('text-[#2563EB]', 'hover:underline');
                    clearInterval(resendTimer);
                    resendTimer = setInterval(() => {
                      timeLeft -= 1;
                      countdown.textContent = `ارسال مجدد تا ${timeLeft} ثانیه`;
                      if (timeLeft <= 0) {
                        clearInterval(resendTimer);
                        resendBtn.disabled = false;
                        resendBtn.classList.remove('text-gray-400', 'cursor-not-allowed');
                        resendBtn.classList.add('text-[#2563EB]', 'hover:underline');
                        countdown.textContent = 'می‌توانید دوباره درخواست دهید';
                      }
                    }, 1000);
                  };

                  const showOtpStep = (phoneNumber) => {
                    registerStep.classList.add('hidden');
                    registerStep.setAttribute('aria-hidden', 'true');
                    otpPhoneDisplay.textContent = phoneNumber.replace(/(\d{4})\d{5}(\d{2})/, '$1*****$2');
                    otpPhoneDisplay.style.unicodeBidi = 'plaintext';
                    otpStep.classList.remove('hidden');
                    otpStep.classList.add('opacity-0');
                    requestAnimationFrame(() => {
                      otpStep.classList.remove('opacity-0');
                    });
                    otpStep.removeAttribute('aria-hidden');
                    otpInputs.forEach((input) => (input.value = ''));
                    otpInputs[0].focus();
                    resetResendTimer();
                  };

                  const showRegisterStep = () => {
                    otpStep.classList.add('hidden');
                    otpStep.setAttribute('aria-hidden', 'true');
                    registerStep.classList.remove('hidden');
                    registerStep.classList.add('opacity-0');
                    requestAnimationFrame(() => {
                      registerStep.classList.remove('opacity-0');
                    });
                    registerStep.removeAttribute('aria-hidden');
                    sendOtpBtn.disabled = false;
                    sendOtpBtn.innerHTML = 'دریافت کد تایید <span class="material-icon text-sm" aria-hidden="true">send</span>';
                    setOtpError('');
                    setRegisterError('');
                    clearInterval(resendTimer);
                    countdown.textContent = 'ارسال مجدد تا 60 ثانیه';
                  };

                  registerForm.addEventListener('submit', (e) => {
                    e.preventDefault();

                    const firstName = firstNameInput.value.trim();
                    const lastName = lastNameInput.value.trim();
                    const phoneNumber = phoneInput.value.replace(/[^0-9]/g, '').slice(0, 11);
                    phoneInput.value = phoneNumber;

                    if (!firstName || !lastName) {
                      setRegisterError('لطفاً نام و نام خانوادگی را وارد کنید');
                      return;
                    }

                    if (!phoneNumber || !/^09[0-9]{9}$/.test(phoneNumber)) {
                      setRegisterError('لطفاً شماره موبایل معتبر وارد کنید');
                      return;
                    }
                    setRegisterError('');

                    sendOtpBtn.innerHTML = '<span class="material-icon text-sm animate-spin">refresh</span> در حال ارسال...';
                    sendOtpBtn.disabled = true;

                    const registrationData = {
                      firstName: firstName,
                      lastName: lastName,
                      phone: phoneNumber
                    };
                    sessionStorage.setItem('registrationData', JSON.stringify(registrationData));
                    sessionStorage.setItem('registerPhone', phoneNumber);

                    setTimeout(() => {
                      showOtpStep(phoneNumber);
                    }, 900);
                  });

                  firstNameInput.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^آ-ی\s]/g, '').slice(0, 24);
                  });

                  lastNameInput.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^آ-ی\s]/g, '').slice(0, 32);
                  });

                  phoneInput.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 11);
                    if (e.target.value.length === 11) setRegisterError('');
                  });

                  otpInputs.forEach((input, index) => {
                    input.addEventListener('input', (e) => {
                      e.target.value = e.target.value.replace(/[^0-9]/g, '');
                      if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                      }
                    });

                    input.addEventListener('keydown', (e) => {
                      if (e.key === 'Backspace' && e.target.value.length === 0 && index > 0) {
                        otpInputs[index - 1].focus();
                      }
                    });

                    input.addEventListener('paste', (e) => {
                      e.preventDefault();
                      const pastedData = e.clipboardData.getData('text').slice(0, 4);
                      const digits = pastedData.replace(/[^0-9]/g, '');
                      digits.split('').forEach((digit, i) => {
                        if (otpInputs[i]) {
                          otpInputs[i].value = digit;
                        }
                      });
                      const nextEmpty = Array.from(otpInputs).findIndex((inp) => inp.value === '');
                      if (nextEmpty !== -1) {
                        otpInputs[nextEmpty].focus();
                      } else {
                        otpInputs[otpInputs.length - 1].focus();
                      }
                    });
                  });

                  resendBtn.addEventListener('click', () => {
                    if (resendBtn.disabled) return;
                    setOtpError('کد تایید مجدد ارسال شد');
                    otpInputs.forEach((input) => (input.value = ''));
                    otpInputs[0].focus();
                    resetResendTimer();
                  });

                  editPhoneBtn.addEventListener('click', () => {
                    showRegisterStep();
                    phoneInput.focus();
                  });

                  otpForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const otpCode = Array.from(otpInputs).map((input) => input.value).join('');
                    if (otpCode.length !== 4) {
                      setOtpError('لطفاً کد ۴ رقمی را وارد کنید');
                      return;
                    }
                    setOtpError('');
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<span class="material-icon text-sm animate-spin">refresh</span> در حال بررسی...';
                    submitBtn.disabled = true;
                    setTimeout(() => {
                      window.mahanToast.queue({
                        type: 'success',
                        title: 'ثبت نام با موفقیت انجام شد'
                      });
                      setOtpError('');
                      sessionStorage.removeItem('registrationData');
                      sessionStorage.removeItem('registerPhone');
                      setTimeout(() => {
                        window.location.href = '../index.html';
                      }, 800);
                    }, 1200);
                    setTimeout(() => {
                      submitBtn.innerHTML = originalText;
                      submitBtn.disabled = false;
                    }, 1500);
                  });
                });
        </script>
    }

</body>
</html>



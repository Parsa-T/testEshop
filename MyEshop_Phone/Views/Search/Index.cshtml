@using MyEshop_Phone.Domain.Model
@model IEnumerable<_Products>
@{
    ViewData["Title"] = "جستجوی کالا";
}

<main id="main-content" class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 pt-5 pb-6 md:pb-8">
    <div class="lg:grid lg:grid-cols-12 lg:gap-8">

        <!-- Filter Sidebar -->
        @await Component.InvokeAsync("FilterSearch")

        <!-- Products Grid -->
        <div class="lg:col-span-9 mt-6 lg:mt-0">
            <!-- Header: Sort + Results count -->
            <div class="products-header flex flex-col gap-4 p-4 mb-6 bg-gradient-to-r from-[#DBEAFE]/40 to-[#F8FAFC] rounded-3xl border border-gray-200 shadow-[0_20px_60px_rgba(37,99,235,0.12)]" role="heading" aria-level="2">
                <div class="products-header-main flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                    <div class="products-header-sort flex items-center gap-3 flex-1 min-w-[220px]">
                        <span class="material-icon text-[#2563EB] text-2xl">sort</span>
                        <label for="sort-by" class="font-semibold text-sm text-gray-700">تعداد "@Model.Count()" با عبارت "@ViewBag.Name" یافت شد.</label>
                        @* <div class="relative flex-1 sm:flex-none sm:w-56">
                            <select id="sort-by" class="sort-select bg-white border border-gray-200 text-gray-900 text-sm rounded-2xl focus:ring-2 focus:ring-[#2563EB] focus:border-[#2563EB] block w-full pr-3 pl-10 py-2.5 appearance-none shadow-sm hover:shadow-md transition">
                                <option value="newest">جدیدترین</option>
                                <option value="oldest">قدیمی‌ترین</option>
                                <option value="price-asc">قیمت: از کم به زیاد</option>
                                <option value="price-desc">قیمت: از زیاد به کم</option>
                            </select>
                            <span class="material-icon absolute left-3 top-1/2 -translate-y-1/2 text-[#2563EB] pointer-events-none text-lg">unfold_more</span>
                        </div> *@
                    </div>
                </div>
                <div class="filters-toolbar flex flex-col gap-3">
                    <div class="filters-toolbar-row flex flex-wrap gap-3 items-center justify-between">
                        <div class="filters-toolbar-chips flex flex-wrap justify-end gap-2">
                            <div id="selected-filters" class="selected-filters" style="display:none;" aria-live="polite"></div>
                        </div>
                        <button id="mobile-filter-btn" class="filters-open-btn lg:hidden w-full justify-center" type="button" aria-label="باز کردن فیلترها" aria-expanded="false" aria-controls="filter-sidebar">
                            <span class="material-icon text-xl font-semibold">tune</span>
                            <span class="text-sm font-bold">فیلترهای پیشرفته</span>
                        </button>
                    </div>
                    <div class="active-category-row flex lg:hidden">
                        <div class="active-category-pill rounded-full border border-gray-200 bg-white/80 px-3 py-1 text-xs sm:text-sm flex items-center gap-2 shadow-sm">
                            <span class="material-icon text-[#2563EB] text-base">category</span>
                            <span>دسته انتخاب‌شده:</span>
                            <span id="active-category-name" class="font-bold text-[#1A1441]">تمام محصولات</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="products-grid-shell relative">
                <div id="products-container2" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 sm:gap-3 md:gap-4 lg:gap-5">
                    <!-- Product cards will be dynamically populated/filtered. -->
                    @foreach (var item in Model)
                    {
                        <article class="product-card product-card--hero has-flush-media bg-white rounded-3xl p-4 border border-gray-100 group"
                                 data-category="@item.products_Groups.GroupTitle"
                                 data-brand="@item.ShortDescription"
                                 data-model="@item.Title"
                                 data-material="silicone"
                                 data-price="@item.Price"
                                 data-popular="9"
                                 data-new="@item.CreateTime.ToString("yyyy-MM-dd")"
                                 data-stock="true">
                            <div class="relative">
                                <div class="product-media product-media--flush rounded-2xl bg-[#F7F5FA] flex items-center justify-center overflow-hidden" data-media-width="900" data-media-height="900">
                                    <img src="/AdminPanel/Photo/Products/@item.ImageName" alt="@item.Title" class="w-full h-full object-contain" width="900" height="900" loading="lazy">
                                </div>

                                @* <div class="product-card-color-strip" aria-label="رنگ‌های موجود">
                                    <span class="color-swatch bg-slate-900" data-color-hex="#0f172a" title="مشکی" aria-label="مشکی"></span>
                                    <span class="color-swatch bg-zinc-400" data-color-hex="#a1a1aa" title="خاکستری" aria-label="خاکستری"></span>
                                </div> *@
                            </div>

                            <div class="mt-4">
                                <a href="/Product/@item.Id">
                                    <h3 class="font-extrabold text-gray-900 text-sm md:text-base leading-tight truncate">@item.Title</h3>
                                </a>
                                <p class="text-[11px] md:text-xs text-gray-500 mt-1">برند: @item.ShortDescription</p>
                            </div>

                            <div class="mt-3 flex items-center justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="text-[10px] md:text-xs text-gray-400 line-through">@item.Price.ToString("N0")</div>
                                    <div class="text-base md:text-lg font-black text-[#2563EB] leading-tight">
                                        @item.Price.ToString("N0") <span class="text-[10px] md:text-xs font-medium text-gray-500">تومان</span>
                                    </div>
                                </div>

                                @if (User.Identity.IsAuthenticated)
                                {
                                    @if (item.Count != 0)
                                    {
                                        <div class="flex items-center gap-2">
                                            <button aria-label="افزودن به سبد خرید" data-id="@item.Id" class="add-to-cart-btn nav-icon-btn ripple w-10 h-10 rounded-2xl bg-[#2563EB] text-white flex items-center justify-center hover:bg-[#1E3A8A] transition shadow-sm" type="button">
                                                <span class="material-icon text-[22px]">add</span>
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="flex items-center gap-2">
                                            <p style="color:red">موجود در انبار نمیباشد</p>
                                        </div>
                                    }
                                }
                            </div>
                        </article>
                    }
                </div>

                <div id="no-results" class="no-results hidden" role="status" aria-live="polite">
                    <div class="no-results-card rounded-3xl border border-dashed border-[#BFDBFE]/70 bg-white/90 shadow-lg shadow-blue-50 p-6 text-center">
                        <span class="material-icon text-6xl text-[#2563EB] mb-4 inline-block">search_off</span>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">محصول پیدا نشد !</h3>
                        <p class="text-sm text-gray-600 mb-4">محصولی با این فیلتر ها پیدا نشد یا هنوز موجود نمیباشد برای دیدن سایر محصولات فیلتر هارا تعویض کنید.</p>
                        <div class="flex flex-wrap justify-center gap-3">
                            <button id="reset-filters-btn-mobile" class="px-4 py-2 rounded-2xl bg-[#2563EB] text-white text-sm font-bold shadow-md hover:bg-[#1D4ED8] transition">حذف تمام فیلتر ها</button>
                            <a href="../index.html" class="px-4 py-2 rounded-2xl border border-gray-200 text-sm font-semibold text-gray-700 hover:bg-[#EFF6FF] transition">بازگشت به خانه</a>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</main>

<!-- Mobile Filter Button and Overlay -->
<div id="filter-overlay" class="filter-overlay" role="presentation"></div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const productsContainer = document.getElementById("products-container2");
            const applyBtn = document.getElementById("apply-filters-btn");
            const priceMin = document.getElementById("price-min");
            const priceMax = document.getElementById("price-max");
            const inStockToggle = document.getElementById("in-stock-toggle");

            // -------------------------------
            // گرفتن مقادیر فیلتر
            // -------------------------------
            function getFilters() {

                const activeCategory = document.querySelector(".category-filter-btn.active");
                const category = activeCategory ? activeCategory.dataset.category : "all";

                const brandCheckboxes = document.querySelectorAll(".filter-input:checked");
                const brands = Array.from(brandCheckboxes).map(cb => cb.value);

                const minPrice = priceMin ? priceMin.value : null;
                const maxPrice = priceMax ? priceMax.value : null;

                const inStock = inStockToggle ? inStockToggle.checked : false;

                return { category, brands, minPrice, maxPrice, inStock };
            }

            // -------------------------------
            // رندر محصولات
            // -------------------------------
            function renderProducts(products) {

                if (!productsContainer) return;

                productsContainer.innerHTML = "";

                if (!products || products.length === 0) {
                    productsContainer.innerHTML =
                        "<p class='col-span-full text-center text-gray-500'>محصولی یافت نشد</p>";
                    return;
                }

                products.forEach(product => {
                    const card = `
                        <div class="bg-white p-4 rounded-xl shadow hover:shadow-lg transition">
                            <img src="${product.imageUrl}"
                                 class="w-full h-40 object-cover rounded-lg mb-3" />
                            <a href="/Product/${product.id}">
                            <h3 class="font-bold text-sm mb-2">${product.name}</h3>
                            </a>
                            <p class="text-blue-600 font-semibold">
                                ${Number(product.price).toLocaleString()} تومان
                            </p>
                        </div>
                    `;
                    productsContainer.insertAdjacentHTML("beforeend", card);
                });
            }

            // -------------------------------
            // صدا زدن API
            // -------------------------------
            async function applyFilters() {

                const filters = getFilters();
                const queryParams = new URLSearchParams();

                if (filters.category && filters.category !== "all")
                    queryParams.append("Category", filters.category);

                filters.brands.forEach(b => queryParams.append("Brands", b));

                if (filters.minPrice)
                    queryParams.append("MinPrice", filters.minPrice);

                if (filters.maxPrice)
                    queryParams.append("MaxPrice", filters.maxPrice);

                if (filters.inStock)
                    queryParams.append("InStock", true);

                try {

                    // لودینگ ساده
                    productsContainer.innerHTML =
                        "<p class='col-span-full text-center'>در حال بارگذاری...</p>";

                    const response = await fetch(`/api/FilterProducts/filter?${queryParams.toString()}`);

                    if (!response.ok) {
                        throw new Error("Server error");
                    }

                    const data = await response.json();
                    renderProducts(data);

                } catch (error) {
                    console.error("خطا در دریافت اطلاعات:", error);
                    productsContainer.innerHTML =
                        "<p class='col-span-full text-center text-red-500'>خطا در دریافت اطلاعات</p>";
                }
            }

            // -------------------------------
            // Debounce برای اسلایدر قیمت
            // -------------------------------
            function debounce(func, delay) {
                let timer;
                return function () {
                    clearTimeout(timer);
                    timer = setTimeout(() => func.apply(this, arguments), delay);
                };
            }

            const debouncedApply = debounce(applyFilters, 400);

            // -------------------------------
            // Event ها
            // -------------------------------

            // دسته‌ها
            document.querySelectorAll(".category-filter-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    document.querySelectorAll(".category-filter-btn")
                        .forEach(b => b.classList.remove("active"));

                    this.classList.add("active");
                    applyFilters();
                });
            });

            // برندها
            document.querySelectorAll(".filter-input").forEach(cb => {
                cb.addEventListener("change", applyFilters);
            });

            // قیمت
            if (priceMin) priceMin.addEventListener("input", debouncedApply);
            if (priceMax) priceMax.addEventListener("input", debouncedApply);

            // موجودی
            if (inStockToggle)
                inStockToggle.addEventListener("change", applyFilters);

            // دکمه اعمال (موبایل)
            if (applyBtn)
                applyBtn.addEventListener("click", applyFilters);

        });
        //حذف فیلتر ها
                document.getElementById("reset-filters").addEventListener("click", function() {

            // 1️⃣ دسته‌ها: کلاس active رو پاک کن و اولی (تمام محصولات) رو فعال کن
            document.querySelectorAll(".category-filter-btn").forEach((btn, index) => {
                btn.classList.remove("active");
                if (index === 0) btn.classList.add("active"); // اولی = "تمام محصولات"
            });

            // 2️⃣ برندها: تمام چک‌باکس‌ها رو uncheck کن
            document.querySelectorAll(".filter-input").forEach(cb => cb.checked = false);

            // 3️⃣ قیمت: بازنشانی به مقدار پیش‌فرض
            const priceMin = document.getElementById("price-min");
            const priceMax = document.getElementById("price-max");
            if (priceMin) priceMin.value = priceMin.min || 0;
            if (priceMax) priceMax.value = priceMax.max || 50000000;

            // 4️⃣ موجودی: uncheck کن
            const inStock = document.getElementById("in-stock-toggle");
            if (inStock) inStock.checked = false;

            // 5️⃣ دوباره فیلتر اعمال کن (اکنون همه مقادیر پیش‌فرض هستند)
            applyFilters();
        });

    </script>
}
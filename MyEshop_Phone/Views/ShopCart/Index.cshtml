@using MyEshop_Phone.Application.ViewModel
@model ShopCartPageViewModel
@{
    ViewData["Title"] = "سبد خرید | ماهان شاپ";
}
@* <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#F8FAFC" />
    <title>سبد خرید | ماهان شاپ</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

</head>
<body class="bg-[#F8FAFC] text-gray-900 overflow-x-hidden"> *@

<link rel="stylesheet" href="/css/cart/style.css" />
@* <div id="top" aria-hidden="true"></div> *@

<!-- هدر اصلی: ناوبری، جستجو و وضعیت ورود کاربر -->
@* <div data-include="header"></div> *@



<main id="main-content" class="relative max-w-7xl mx-auto px-4 py-6 md:py-10">
    <div class="pointer-events-none absolute inset-0 -z-10">
        <div class="absolute -top-16 right-0 w-72 h-72 bg-gradient-to-br from-[#EAD9FF] via-[#F8F4FF] to-transparent blur-3xl opacity-80"></div>
        <div class="absolute -bottom-20 left-0 w-80 h-80 bg-gradient-to-tr from-[#DFF3FF] via-[#F8FBFF] to-transparent blur-3xl opacity-70"></div>
    </div>

    <div class="flex flex-col gap-3 mb-6">
        <p class="text-xs uppercase tracking-[0.35em] text-gray-400">یک قدم تا تکمیل سفارش</p>
        <h1 class="text-3xl md:text-4xl font-black text-gray-900">سبد خرید شما</h1>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-[1.65fr_0.75fr] gap-12 items-start" data-cart-main data-cart-empty="false">
        <section class="space-y-8">
            <div class="flex flex-wrap items-end justify-between gap-4 border-b border-gray-200/70 pb-6">
                <div></div>
            </div>

            <div id="cart-items-wrapper" class="flex flex-col gap-4 rounded-3xl bg-transparent px-3 py-3 max-h-[65vh] overflow-y-auto">
                @foreach (var item in Model.Items)
                {
                    <article class="cart-item" data-cart-item-id="@item.ProductID" data-cart-color="@item.ColorName" data-cart-item="case-iphone-15-silicone" data-unit-price="@item.Price">
                        <div class="cart-item-main">
                            <div class="cart-item-details">
                                <img src="/AdminPanel/Photo/Products/@item.ImageName" alt="@item.Title" class="w-20 h-20 rounded-2xl object-cover">
                                <div class="flex flex-col gap-2">
                                    <a href="/Product/@item.ProductID">
                                        <h2 class="text-lg font-extrabold text-gray-900">@item.Title</h2>
                                    </a>
                                    <p class="text-sm text-gray-500">برند: @item.ShortDescription</p>
                                    @if (!string.IsNullOrEmpty(item.ColorName))
                                    {
                                        <div class="pd-color" title="@item.ColorName">
                                            <span class="pd-color__dot"
                                                  style="background:@item.ColorName; width:20px; height:20px; display:inline-block; border-radius:50%;">
                                            </span>
                                        </div>
                                    }
                                </div>
                            </div>
                            <div class="cart-item-controls">
                                <div class="cart-item-meta">
                                    <div class="cart-actions-row">
                                        <button class="text-sm font-semibold text-red-600 bg-white border border-red-100 hover:bg-red-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-400 transition flex items-center gap-1 px-3 py-1.5 rounded-full shadow-sm shadow-red-50" type="button" aria-label="حذف از سبد خرید" data-action="remove-cart-item">
                                            <span class="material-icon text-sm">delete</span>
                                            حذف
                                        </button>
                                    </div>
                                    <div class="cart-price-amount text-[#2563EB] font-black" data-item-total>@item.Price.ToString("N0") تومان</div>
                                </div>
                                <div class="cart-item-qty">
                                    <div class="cart-qty-group flex items-center justify-center">
                                        <button class="qty-minus" type="button" aria-label="کاهش تعداد">
                                            -
                                        </button>
                                        <input type="text" value="@item.Count" class="border-none bg-transparent font-bold focus:outline-none" readonly>
                                        <button class="qty-plus" type="button" aria-label="افزایش تعداد">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </article>
                }
            </div>

            <div id="cart-empty-state" class="hidden rounded-3xl bg-white/80 backdrop-blur-sm shadow-[0_18px_45px_rgba(37,99,235,0.1)] px-6 py-10 text-center text-gray-500 space-y-3">
                <span class="material-icon text-4xl text-[#2563EB]">shopping_bag</span>
                <p class="text-lg font-bold text-gray-900">سبد خرید شما خالی است</p>
                <p class="text-sm">برای شروع، وارد فروشگاه شوید و بهترین لوازم جانبی را انتخاب کنید.</p>
                <a href="/" class="inline-flex items-center justify-center gap-2 text-sm font-semibold text-[#2563EB] hover:text-[#1D4ED8] transition">
                    <span class="material-icon text-base">arrow_forward</span>
                    برگشت به فروشگاه
                </a>
            </div>
            <!-- این بلوک فقط زمانی فعال شود که سبد واقعا خالی باشد -->
        </section>

        <div id="cart-confirm-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
            <div data-confirm-overlay class="absolute inset-0 bg-black/40"></div>
            <div class="relative w-full max-w-sm rounded-3xl bg-white p-6 text-center shadow-[0_20px_60px_rgba(15,23,42,0.3)]">
                <span class="material-icon text-4xl text-red-500 block mb-3">warning</span>
                <p class="text-lg font-bold text-gray-900 mb-1">حذف محصول از سبد</p>
                <p class="text-sm text-gray-500 mb-4">آیا مطمئن هستید که می‌خواهید این کالا را از سبد حذف کنید؟</p>
                <div class="flex items-center justify-center gap-3">
                    <button data-confirm-cancel class="px-4 py-2 rounded-full border border-gray-200 text-gray-700 text-sm font-semibold hover:bg-gray-100 transition">خیر</button>
                    <button data-confirm-ok class="px-4 py-2 rounded-full bg-red-600 text-white text-sm font-semibold hover:bg-red-700 transition flex items-center gap-2 justify-center">
                        <span class="material-icon text-base">delete</span>
                        حذف کنم
                    </button>
                </div>
            </div>
        </div>

        <section class="space-y-6 lg:pr-10 lg:border-r lg:border-gray-200/70">
            @{
                var subtotal = Model.Items.Sum(item => item.Price * item.Count);
            }
            <div class="sticky top-0 space-y-6">
                <div class="rounded-3xl bg-white/80 backdrop-blur-sm shadow-[0_20px_50px_rgba(37,99,235,0.12)] p-6 space-y-4">
                    <h2 class="text-xl font-bold text-gray-900">خلاصه سبد خرید</h2>
                    <div class="space-y-3 text-sm text-gray-700">
                        <div class="flex justify-between items-center">
                            <span>جمع کل</span>
                            <strong data-cart-subtotal class="text-[#2563EB] font-black">@subtotal.ToString("N0") تومان</strong>
                        </div>
                        <div class="flex justify-between items-center border-t border-gray-200/70 pt-3 font-black text-lg">
                            <span>قابل پرداخت</span>
                            <strong class="text-[#2563EB]" data-cart-grandtotal>@subtotal.ToString("N0") تومان</strong>
                        </div>
                    </div>
                </div>
                @if (Model.IsLoggedIn)
                {
                    @if (Model.HasAddress)
                    {
                        <div class="rounded-3xl bg-[#EFF6FF]/60 px-6 py-5 shadow-[0_18px_40px_rgba(37,99,235,0.08)] space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs uppercase tracking-[0.3em] text-gray-400">اطلاعات ارسال</p>
                                    <h3 class="text-lg font-semibold text-gray-900">@Model.FullName</h3>
                                </div>
                                <span class="text-sm font-bold text-green-600">تکمیل شده</span>
                            </div>

                            <div class="space-y-2 text-sm text-gray-700">
                                <p><strong>آدرس:</strong> @Model.Address</p>
                                <p><strong>کد پستی:</strong> @Model.PostalCode</p>
                            </div>
                        </div>

                        <form method="post" asp-action="FinalizeOrder">
                            <div class="space-y-3">
                                <button type="submit" id="btnSubmitOrder"
                                        class="w-full bg-[#2563EB] text-white font-bold py-3.5 rounded-full hover:bg-[#1D4ED8] transition-colors shadow-lg shadow-[#2563EB]/20 flex items-center justify-center gap-2 ripple">
                                    ادامه و ثبت سفارش
                                    <span class="material-icon text-sm">shopping_bag</span>
                                </button>
                                <a href="/" class="block text-center text-sm text-gray-500 hover:text-gray-800">
                                    بازگشت به فروشگاه
                                </a>
                            </div>
                        </form>
                    }
                    else
                    {
                        <div class="rounded-3xl bg-[#EFF6FF]/60 px-6 py-5 shadow-[0_18px_40px_rgba(37,99,235,0.08)] space-y-4" data-address-card data-address-added="false">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs uppercase tracking-[0.3em] text-gray-400">آدرس ارسال</p>
                                    <h3 class="text-lg font-semibold text-gray-900">آدرسی ثبت نشده است</h3>
                                </div>
                                <span class="text-sm font-bold text-red-500">نیاز به اتمام</span>
                            </div>
                            <div data-address-empty class="space-y-2 text-sm text-gray-600">
                                <p>در حال حاضر هیچ آدرسی به سبد متصل نیست.</p>
                                <div class="flex items-start gap-2 border-r-2 border-red-300 pr-3 text-red-600 text-xs font-semibold">
                                    <span class="material-icon text-base">warning</span>
                                    برای ثبت سفارش باید یک آدرس در صفحه پروفایل اضافه کنید.
                                </div>
                                <a href="/PanelUser/Edit?id=@Model.Id" class="inline-flex items-center gap-2 text-sm font-semibold text-[#2563EB] hover:text-[#1D4ED8] transition">
                                    رفتن به ثبت آدرس
                                    <span class="material-icon text-base">arrow_forward</span>
                                </a>
                            </div>
                            <!-- اگر آدرسی ثبت شود، حالت دوم نمایش پیدا می‌کند -->
                        </div>
                    }
                }
                else
                {
                    <div class="rounded-3xl bg-[#EFF6FF]/60 px-6 py-5 shadow-[0_18px_40px_rgba(37,99,235,0.08)] space-y-4" data-address-card data-address-added="false">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs uppercase tracking-[0.3em] text-gray-400">برای تکمیل سفارش باید وارد اکانتتون بشید</p>
                                <h3 class="text-lg font-semibold text-gray-900">برای تکمیل سفارش باید وارد اکانتتون بشید</h3>
                            </div>
                            <span class="text-sm font-bold text-red-500">نیاز به اکانت</span>
                        </div>
                        <div data-address-empty class="space-y-2 text-sm text-gray-600">
                            <p>در حال حاظر شما وارد اکانت نشدید</p>
                            <div class="flex items-start gap-2 border-r-2 border-red-300 pr-3 text-red-600 text-xs font-semibold">
                                <span class="material-icon text-base">warning</span>
                                برای ثبت سفارش باید وارد اکانت خود بشید
                            </div>
                            <a href="/Login" class="inline-flex items-center gap-2 text-sm font-semibold text-[#2563EB] hover:text-[#1D4ED8] transition">
                                صفحه لاگین
                                <span class="material-icon text-base">arrow_forward</span>
                            </a>
                        </div>
                        <!-- اگر آدرسی ثبت شود، حالت دوم نمایش پیدا می‌کند -->
                    </div>
                }
            </div>
        </section>
    </div>
</main>

<div id="cart-toast" class="cart-toast" role="status" aria-live="polite" aria-atomic="true"></div>

@* <div data-include="footer"></div> *@

<script>
    document.addEventListener('DOMContentLoaded', () => {
      const cartMain = document.querySelector('[data-cart-main]');
      const itemWrapper = document.getElementById('cart-items-wrapper');
      const emptyState = document.getElementById('cart-empty-state');
      if (cartMain && itemWrapper && emptyState) {
        const isEmpty = cartMain.dataset.cartEmpty === 'true';
        itemWrapper.classList.toggle('hidden', isEmpty);
        emptyState.classList.toggle('hidden', !isEmpty);
      }

      const addressCard = document.querySelector('[data-address-card]');
      if (addressCard) {
        const hasAddress = addressCard.dataset.addressAdded === 'true';
        const emptyNotice = addressCard.querySelector('[data-address-empty]');
        const filledNotice = addressCard.querySelector('[data-address-filled]');
        if (emptyNotice && filledNotice) {
          emptyNotice.classList.toggle('hidden', hasAddress);
          filledNotice.classList.toggle('hidden', !hasAddress);
        }
      }

      initCartAjax();
    });

    function initCartAjax() {
      const cartWrapper = document.getElementById('cart-items-wrapper');
      if (!cartWrapper) return;
      const cartMain = document.querySelector('[data-cart-main]');
      const emptyState = document.getElementById('cart-empty-state');
      const subtotalEl = document.querySelector('[data-cart-subtotal]');
      const grandtotalEl = document.querySelector('[data-cart-grandtotal]');
      const shippingRow = document.querySelector('[data-cart-shipping-row]');
      const shippingValue = Number(shippingRow?.dataset?.shippingValue ?? '0') || 0;
      const currencyFormatter = new Intl.NumberFormat('fa-IR');
      const confirmModal = document.getElementById('cart-confirm-modal');
      const confirmOverlay = confirmModal?.querySelector('[data-confirm-overlay]');
      const confirmOk = confirmModal?.querySelector('[data-confirm-ok]');
      const confirmCancel = confirmModal?.querySelector('[data-confirm-cancel]');
      const toastEl = document.getElementById('cart-toast');
      let toastTimeoutId = null;
      let pendingRemoval = null;

      const closeConfirmModal = () => {
        if (!confirmModal) return;
        confirmModal.classList.add('hidden');
        pendingRemoval = null;
        document.body.classList.remove('overflow-hidden');
      };

      const openConfirmModal = (article) => {
        if (!confirmModal || !article) {
          handleRemove(article);
          return;
        }
        pendingRemoval = article;
        confirmModal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
      };

      confirmOverlay?.addEventListener('click', () => closeConfirmModal());
      confirmCancel?.addEventListener('click', () => closeConfirmModal());
      confirmOk?.addEventListener('click', () => {
        if (!pendingRemoval) {
          closeConfirmModal();
          return;
        }
        handleRemove(pendingRemoval);
        closeConfirmModal();
      });
      document.addEventListener('keydown', (event) => {
        if (!pendingRemoval) return;
        if (event.key === 'Escape') {
          event.preventDefault();
          closeConfirmModal();
        }
      });

      const formatCurrency = (value) => `${currencyFormatter.format(Math.round(value))} تومان`;
      const parseQty = (input) => Math.max(1, parseInt(input?.value ?? '1', 10) || 1);
      const getItems = () => Array.from(cartWrapper.querySelectorAll('[data-cart-item]'));

      const updateVisibility = () => {
        const hasItems = getItems().length > 0;
        cartWrapper.classList.toggle('hidden', !hasItems);
        if (emptyState) emptyState.classList.toggle('hidden', hasItems);
        if (cartMain) cartMain.dataset.cartEmpty = hasItems ? 'false' : 'true';
      };

      const recalcSummary = () => {
        const subtotal = getItems().reduce((sum, article) => {
          const unitPrice = Number(article.dataset.unitPrice ?? '0') || 0;
          const qtyInput = article.querySelector('input[type="text"]');
          const qty = parseQty(qtyInput);
          return sum + unitPrice * qty;
        }, 0);
        if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
        if (grandtotalEl) grandtotalEl.textContent = formatCurrency(subtotal + shippingValue);
      };

      const toggleItemLoading = (article, isLoading) => {
        if (!article) return;
        article.classList.toggle('is-updating', isLoading);
        article.setAttribute('aria-busy', isLoading ? 'true' : 'false');
        article.querySelectorAll('button, input').forEach((control) => {
          control.disabled = isLoading;
        });
      };

      const simulateAjax = () => new Promise((resolve) => {
        const delay = 220 + Math.random() * 180;
        setTimeout(resolve, delay);
      });

      const showToast = (message, options = {}) => {
        if (!message) return;

        // Prefer global toast system (script.js)
        if (window.mahanToast && typeof window.mahanToast.show === 'function') {
          window.mahanToast.show({
            type: options.type || 'success',
            title: message,
            icon: options.icon,
            duration: options.duration || (options.type === 'danger' ? 6000 : 2500),
            action: options.action,
            showCloseButton: false
          });
          return;
        }

        // Fallback (legacy toast)
        if (!toastEl) return;
        toastEl.textContent = message;
        toastEl.classList.add('is-visible');
        if (toastTimeoutId) clearTimeout(toastTimeoutId);
        toastTimeoutId = setTimeout(() => {
          toastEl.classList.remove('is-visible');
        }, 2800);
      };

      const updateItemVisuals = (article, quantity) => {
        if (!article) return;
        const qtyInput = article.querySelector('input[type="text"]');
        const totalEl = article.querySelector('[data-item-total]');
        const unitPrice = Number(article.dataset.unitPrice ?? '0') || 0;
        const qty = Math.max(1, quantity);
        if (qtyInput) qtyInput.value = qty;
        if (totalEl) totalEl.textContent = formatCurrency(unitPrice * qty);
      };

      const handleQtyChange = async (article, delta) => {
        if (!article) return;
        const qtyInput = article.querySelector('input[type="text"]');
        const currentQty = parseQty(qtyInput);
        const nextQty = Math.max(1, currentQty + delta);
        if (nextQty === currentQty) return;
        toggleItemLoading(article, true);
        try {
          await simulateAjax();
          updateItemVisuals(article, nextQty);
          recalcSummary();
        } finally {
          toggleItemLoading(article, false);
        }
      };

      const handleRemove = async (article, successMessage = 'کالا از سبد حذف شد') => {
        if (!article) return;
        const productId = Number(article.dataset.cartItemId ?? '0');
        const snapshotHtml = article.outerHTML;
        const siblings = getItems();
        const index = siblings.indexOf(article);
        toggleItemLoading(article, true);
        try {
          const response = await fetch(`/api/shop/${productId}`, {
            method: 'DELETE',
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });
          if (!response.ok) return;
          article.remove();
          if (typeof window.countShopCart === 'function') {
            window.countShopCart();
          }
        } finally {
          toggleItemLoading(article, false);
        }
        recalcSummary();
        updateVisibility();

        showToast('از سبد خرید حذف شد', {
          type: 'danger',
          icon: 'cancel',
          duration: 7000,
          action: {
            label: 'بازگردانی',
            onClick: () => {
              try {
                const temp = document.createElement('div');
                temp.innerHTML = snapshotHtml;
                const restored = temp.firstElementChild;
                if (!restored) return;
                const beforeEl = cartWrapper.children[index] || null;
                cartWrapper.insertBefore(restored, beforeEl);
                updateVisibility();
                recalcSummary();
              } catch { /* ignore */ }
            }
          }
        });
      };

      cartWrapper.addEventListener('click', (event) => {
        const plusBtn = event.target.closest('.qty-plus');
        const minusBtn = event.target.closest('.qty-minus');
        const removeBtn = event.target.closest('[data-action="remove-cart-item"]');
        if (!plusBtn && !minusBtn && !removeBtn) return;
        event.preventDefault();
        const trigger = plusBtn || minusBtn || removeBtn;
        const article = trigger?.closest('[data-cart-item]');
        if (!article || article.classList.contains('is-updating')) return;
        if (removeBtn) {
          openConfirmModal(article);
          return;
        }
        if (plusBtn) {
          handleQtyChange(article, 1);
        } else if (minusBtn) {
          handleQtyChange(article, -1);
        }
      });

      updateVisibility();
      recalcSummary();
    }
</script>
